{% extends 'base.html' %}
{% block content %}
  <h2>OAuth Client-side Test (PKCE)</h2>
  <p>This page performs the full PKCE flow in your browser using Yoto's documented endpoints. It will redirect to Yoto, return here with a code, exchange it for tokens, and display the result below.</p>

  <pre id="log" style="background:#f7f7f7;padding:1rem;border-radius:.5rem;white-space:pre-wrap"></pre>
  <script>
    const clientId = {{ client_id|tojson }};
    const audience = {{ audience|tojson }};
    const authUrl = 'https://login.yotoplay.com/authorize';
    const tokenUrl = 'https://login.yotoplay.com/oauth/token';
    const scope = 'offline_access';

    const logEl = document.getElementById('log');
    function log(...args){
      logEl.textContent += args.join(' ') + '\n';
    }

    function base64url(arraybuffer) {
      const bytes = new Uint8Array(arraybuffer);
      let str = '';
      for (let i = 0; i < bytes.byteLength; i++) { str += String.fromCharCode(bytes[i]); }
      return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    async function sha256(verifier) {
      const data = new TextEncoder().encode(verifier);
      const digest = await crypto.subtle.digest('SHA-256', data);
      return base64url(digest);
    }

    function randomVerifier(len = 64) {
      const bytes = new Uint8Array(len);
      crypto.getRandomValues(bytes);
      // Convert to base64url string
      let str = '';
      for (let i = 0; i < bytes.length; i++) { str += String.fromCharCode(bytes[i]); }
      return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    (async function main(){
      if (!clientId) { log('Missing client_id. Set YOTO_CLIENT_ID in env.'); return; }
      const url = new URL(window.location.href);
      const code = url.searchParams.get('code');
      const state = url.searchParams.get('state');
      const redirectUri = window.location.origin + '/auth/test';

      if (!code) {
        const verifier = randomVerifier(64);
        const challenge = await sha256(verifier);
        sessionStorage.setItem('pkce_code_verifier', verifier);
        const params = new URLSearchParams({
          response_type: 'code',
          client_id: clientId,
          redirect_uri: redirectUri,
          audience: audience,
          scope: scope,
          code_challenge: challenge,
          code_challenge_method: 'S256',
          state: Math.random().toString(36).slice(2)
        });
        const full = authUrl + '?' + params.toString();
        log('Redirecting to', full.split('?')[0], '...');
        window.location.replace(full);
        return;
      }

      // Exchange code for tokens
      const verifier = sessionStorage.getItem('pkce_code_verifier');
      if (!verifier) { log('Missing PKCE verifier in sessionStorage.'); return; }
      const body = new URLSearchParams({
        grant_type: 'authorization_code',
        client_id: clientId,
        code_verifier: verifier,
        code: code,
        redirect_uri: redirectUri
      });
      log('Exchanging code for tokens at', tokenUrl, 'redirect_uri=', redirectUri);
      const res = await fetch(tokenUrl, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' }, body });
      const text = await res.text();
      log('Status:', res.status);
      log(text);
      try { sessionStorage.removeItem('pkce_code_verifier'); } catch {}
      // Clean query params
      try { history.replaceState({}, '', redirectUri); } catch {}
    })();
  </script>
{% endblock %}
